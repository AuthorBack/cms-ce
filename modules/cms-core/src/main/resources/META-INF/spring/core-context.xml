<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

  <context:annotation-config/>
  <context:property-placeholder properties-ref="config"/>

  <context:component-scan base-package="com.enonic.cms.core"/>
  <context:component-scan base-package="com.enonic.cms.store"/>
  <context:component-scan base-package="com.enonic.cms.business"/>
  <context:component-scan base-package="com.enonic.cms.framework"/>

  <bean id="verticalProperties" class="com.enonic.vertical.VerticalProperties"/>

  <tx:annotation-driven transaction-manager="transactionManager"/>

  <bean id="dataSource" class="com.enonic.cms.store.support.DataSourceFactory">
    <property name="jndiName" value="java:comp/env/jdbc/cms"/>
  </bean>

  <bean id="dialect" class="com.enonic.cms.framework.jdbc.dialect.DialectFactory">
    <property name="dataSource" ref="dataSource"/>
    <property name="dialectName" value="${cms.jdbc.dialect}"/>
  </bean>

  <bean id="sessionFactory" class="com.enonic.cms.store.support.HibernateConfigurator">
    <property name="dialect" ref="dialect"/>
    <property name="dataSource" ref="dataSource"/>
    <property name="configLocation" value="classpath:com/enonic/cms/store/hibernate.cfg.xml"/>
    <property name="useTransactionAwareDataSource" value="false"/>
    <property name="logging" value="${cms.jdbc.logging}"/>
  </bean>

  <bean id="hibernateTemplate" class="org.springframework.orm.hibernate3.HibernateTemplate">
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>

  <bean id="decoratorManager" class="com.enonic.cms.store.support.DecoratorManager">
    <property name="logging" value="${cms.jdbc.logging}"/>
    <property name="sessionFactory" ref="sessionFactory"/>
    <property name="dialect" ref="dialect"/>
  </bean>

  <bean id="connectionFactory" class="com.enonic.cms.store.support.ConnectionFactory">
    <property name="sessionFactory" ref="sessionFactory"/>
    <property name="decorator" ref="decoratorManager"/>
    <property name="dataSource" ref="dataSource"/>
  </bean>

  <bean id="transactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
    <property name="dataSource" ref="dataSource"/>
    <property name="sessionFactory" ref="sessionFactory"/>
    <property name="defaultTimeout" value="${cms.tx.defaultTimeout}"/>
  </bean>

  <bean name="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
    <property name="transactionManager" ref="transactionManager"/>
  </bean>

  <bean id="databaseInitializer" class="com.enonic.cms.core.jdbc.DatabaseInitializer">
    <property name="adminService" ref="adminService"/>
    <property name="userStoreService" ref="userStoreService"/>
    <property name="upgradeService" ref="upgradeService"/>
  </bean>

  <bean id="keyService" class="com.enonic.cms.core.service.KeyServiceImpl">
    <property name="keyHandler" ref="keyHandler"/>
  </bean>

  <bean id="upgradePropertyResolver" class="com.enonic.cms.upgrade.service.StandardPropertyResolver"/>

  <bean id="upgradeService" class="com.enonic.cms.upgrade.service.UpgradeServiceImpl">
    <property name="connectionFactory" ref="connectionFactory"/>
    <property name="dialect" ref="dialect"/>
    <property name="transactionTemplate" ref="transactionTemplate"/>
    <property name="propertyResolver" ref="upgradePropertyResolver"/>
  </bean>

  <bean id="dataSourceService" class="com.enonic.cms.core.service.DataSourceServiceImpl">
    <property name="calendarService" ref="calendarService"/>
    <property name="contentService" ref="contentService"/>
    <property name="contentDao" ref="contentDao"/>
    <property name="userDao" ref="userDao"/>
    <property name="presentationEngine" ref="presentationEngine"/>
    <property name="preferenceService" ref="preferenceService"/>
    <property name="securityService" ref="securityService"/>
    <property name="countryService" ref="countryService"/>
    <property name="localeService" ref="localeService"/>
    <property name="timeZoneService" ref="timeZoneService"/>
    <property name="timeService" ref="timeService"/>
    <property name="userStoreService" ref="userStoreService"/>
    <property name="sitePropertiesService" ref="sitePropertiesService"/>
  </bean>

  <bean id="userServicesEngine" class="com.enonic.vertical.engine.UserServicesEngine"/>
  <bean id="userServicesService" class="com.enonic.cms.core.service.UserServicesServiceImpl"/>

  <bean id="tightestCacheSettingsResolver" class="com.enonic.cms.core.TightestCacheSettingsResolver"/>

  <bean id="resolverInputXMLCreator" class="com.enonic.cms.core.resolver.ResolverInputXMLCreator"/>

  <bean id="resolverXMLCreator" class="com.enonic.cms.core.resolver.ResolverHttpRequestInputXMLCreator"/>

  <bean id="resolverInputCreator" class="com.enonic.cms.core.resolver.ResolverHttpRequestInputCreator"/>

  <bean id="cookieOrSessionForcedResolverValueService"
        class="com.enonic.cms.core.resolver.ForceResolverValueServiceImpl"/>

  <bean id="sessionCachedResolverValueService" class="com.enonic.cms.core.resolver.CacheResolverValueServiceImpl"/>

  <bean id="deviceClassificationService"
        class="com.enonic.cms.core.resolver.deviceclass.DeviceClassResolverServiceImpl">
    <property name="deviceClassScriptResolver" ref="deviceClassXsltScriptResolver"/>
    <property name="forceResolverValueService" ref="cookieOrSessionForcedResolverValueService"/>
    <property name="cacheResolverValueService" ref="sessionCachedResolverValueService"/>
  </bean>

  <bean id="localeResolverService"
        class="com.enonic.cms.core.resolver.locale.LocaleResolverServiceImpl">
    <property name="localeScriptResolver" ref="localeXsltScriptResolver"/>
    <property name="forceResolverValueService" ref="cookieOrSessionForcedResolverValueService"/>
  </bean>

  <bean id="localeXsltScriptResolver"
        class="com.enonic.cms.core.resolver.locale.LocaleXsltScriptResolver"/>

  <bean id="adminConsoleTranslationService"
        class="com.enonic.cms.core.AdminConsoleTranslationService" init-method="init">
    <property name="defaultLanguageCode" value="${cms.admin.defaultLanguage}"/>
  </bean>

  <bean id="userServicesRedirectHelper"
        class="com.enonic.cms.web.portal.services.UserServicesRedirectUrlResolver"/>

  <bean id="reindexContentToolService"
        class="com.enonic.cms.core.tools.ReindexContentToolServiceImpl"/>

  <bean id="timeService" class="com.enonic.cms.core.time.SystemTimeService"/>

  <bean class="org.springframework.mail.javamail.JavaMailSenderImpl">
    <property name="host" value="${cms.mail.smtpHost}"/>
  </bean>

  <bean id="sendMailService" class="com.enonic.cms.core.mail.SendMailServiceImpl">
    <property name="fromMail" value="${cms.admin.email}"/>
  </bean>

  <bean id="loginService" class="com.enonic.cms.core.login.LoginServiceImpl">
    <property name="autologinTimeoutInDays" value="${com.enonic.vertical.presentation.autologinTimeout}"/>
  </bean>

  <bean id="localClient" class="com.enonic.cms.core.client.InternalClientImpl">
    <property name="clientForRemoteInvocations" value="false"/>
    <property name="dataSourceService" ref="dataSourceService"/>
    <property name="internalClientRenderService" ref="internalClientRenderService"/>
    <property name="internalClientContentService" ref="internalClientContentService"/>
    <property name="userDao" ref="userDao"/>
    <property name="resourceService" ref="resourceService"/>
    <property name="preferenceService" ref="preferenceService"/>
    <property name="sitePropertiesService" ref="sitePropertiesService"/>
    <property name="securityService" ref="securityService"/>
    <property name="contentService" ref="contentService"/>
    <property name="contentDao" ref="contentDao"/>
    <property name="previewService" ref="previewService"/>
    <property name="timeService" ref="timeService"/>
    <property name="livePortalTraceService" ref="livePortalTraceService"/>
  </bean>

  <bean id="remoteClient" class="com.enonic.cms.core.client.InternalClientImpl">
    <property name="clientForRemoteInvocations" value="true"/>
    <property name="dataSourceService" ref="dataSourceService"/>
    <property name="internalClientRenderService" ref="internalClientRenderService"/>
    <property name="internalClientContentService" ref="internalClientContentService"/>
    <property name="userDao" ref="userDao"/>
    <property name="resourceService" ref="resourceService"/>
    <property name="preferenceService" ref="preferenceService"/>
    <property name="sitePropertiesService" ref="sitePropertiesService"/>
    <property name="securityService" ref="securityService"/>
    <property name="contentService" ref="contentService"/>
    <property name="contentDao" ref="contentDao"/>
    <property name="previewService" ref="previewService"/>
    <property name="timeService" ref="timeService"/>
    <property name="livePortalTraceService" ref="livePortalTraceService"/>
  </bean>

  <bean id="internalClientContentService"
        class="com.enonic.cms.core.client.InternalClientContentService">
    <property name="siteCachesService" ref="siteCachesService"/>
  </bean>

  <bean class="com.enonic.cms.core.client.LocalClientSetter">
    <property name="localClient" ref="localClient"/>
  </bean>

  <bean id="datasourceExecutorFactory" class="com.enonic.cms.core.portal.datasource.DatasourceExecutorFactory"/>

  <bean id="expressionFunctionsFactory"
        class="com.enonic.cms.core.portal.datasource.expressionfunctions.ExpressionFunctionsFactory"/>

  <bean id="imageService" class="com.enonic.cms.core.portal.image.ImageServiceImpl">
    <property name="directory" value="${cms.blobstore.dir}"/>
  </bean>

  <bean id="blobStore" class="com.enonic.cms.framework.blob.file.FileBlobStore">
    <property name="directory" value="${cms.blobstore.dir}"/>
  </bean>

  <bean id="fileResourceService" class="com.enonic.cms.store.resource.FileResourceServiceImpl">
    <property name="blobStore" ref="blobStore"/>
    <property name="sessionFactory" ref="sessionFactory"/>
    <property name="mimeTypeResolver" ref="mimeTypeResolver"/>
  </bean>

  <bean id="blobStoreGarbageCollector" class="com.enonic.cms.framework.blob.gc.GarbageCollector">
    <property name="finder" ref="usedBlobStoreFinder"/>
    <property name="store" ref="blobStore"/>
  </bean>

  <bean id="usedBlobStoreFinder" class="com.enonic.cms.store.blob.DbUsedBlobKeyFinder">
    <property name="binaryDataDao" ref="binaryDataDao"/>
    <property name="virtualFileDao" ref="virtualFileDao"/>
  </bean>

  <bean id="siteURLResolver" class="com.enonic.cms.core.SiteURLResolver">
    <property name="sitePathPrefix" value="/site"/>
    <property name="sitePropertiesService" ref="sitePropertiesService"/>
  </bean>

  <bean id="siteService" class="com.enonic.cms.core.structure.SiteServiceImpl">
    <property name="siteCachesService" ref="siteCachesService"/>
    <property name="siteContextManager">
      <bean class="com.enonic.cms.core.structure.SiteContextManager"/>
    </property>
    <property name="sitePropertiesService" ref="sitePropertiesService"/>
    <property name="siteDao" ref="siteDao"/>
    <property name="userDao" ref="userDao"/>
  </bean>

  <bean id="adminAjaxService" class="com.enonic.cms.server.service.admin.ajax.AdminAjaxServiceImpl"/>

  <bean id="davConfiguration" class="com.enonic.cms.web.webdav.DavConfiguration">
    <property name="fileResourceService" ref="fileResourceService"/>
    <property name="securityService" ref="securityService"/>
    <property name="resourceAccessResolver" ref="resourceAccessResolver"/>
  </bean>

  <bean id="originalUrlResolver" class="com.enonic.cms.server.service.servlet.OriginalUrlResolver"/>

  <bean id="mbeanExporter" class="org.springframework.jmx.export.MBeanExporter">
    <property name="beans">
      <map>
        <entry key="EnonicCMS:type=Cache,name=Entity" value-ref="cacheEntity"/>
        <entry key="EnonicCMS:type=Cache,name=Page" value-ref="cachePage"/>
        <entry key="EnonicCMS:type=Cache,name=Binary" value-ref="cacheBinary"/>
        <entry key="EnonicCMS:type=Cache,name=Xslt" value-ref="cacheXslt"/>
        <entry key="EnonicCMS:type=Configuration,name=System"
               value-ref="systemProperties"/>
      </map>
    </property>
  </bean>

  <bean id="cacheEntity" class="com.enonic.cms.core.mbean.cache.Entity"/>
  <bean id="cachePage" class="com.enonic.cms.core.mbean.cache.Page"/>
  <bean id="cacheBinary" class="com.enonic.cms.core.mbean.cache.Binary"/>
  <bean id="cacheXslt" class="com.enonic.cms.core.mbean.cache.Xslt"/>

  <bean id="mbeanServerFactory" class="org.springframework.jmx.support.MBeanServerFactoryBean">
    <property name="locateExistingServerIfPossible" value="true"/>
  </bean>

  <bean id="systemProperties" class="com.enonic.cms.core.mbean.configuration.System"/>

  <bean id="siteListener" class="com.enonic.cms.core.mbean.configuration.SiteListener"
        depends-on="siteService"
        destroy-method="destroy">
    <property name="objectNamePrefix" value="EnonicCMS:type=Configuration,name="/>
  </bean>

  <bean id="portalRequestService" class="com.enonic.cms.core.portal.PortalRequestServiceImpl">
    <property name="pageRendererFactory" ref="pageRendererFactory"/>
    <property name="windowRendererFactory" ref="windowRendererFactory"/>
    <property name="dataSourceService" ref="dataSourceService"/>
    <property name="languageDao" ref="languageDao"/>
    <property name="portalAccessService" ref="portalAccessService"/>
    <property name="userDao" ref="userDao"/>
    <property name="portletDao" ref="portletDao"/>
    <property name="siteDao" ref="siteDao"/>
    <property name="pageRequestProcessorFactory" ref="pageRequestProcessorFactory"/>
    <property name="contentDao" ref="contentDao"/>
    <property name="livePortalTraceService" ref="livePortalTraceService"/>
  </bean>

  <bean id="livePortalTraceService" class="com.enonic.cms.core.portal.livetrace.LivePortalTraceServiceImpl">
    <property name="enabled" value="${cms.livePortalTrace.enabled}"/>
    <property name="longestSize" value="${cms.livePortalTrace.longest.size}"/>
    <property name="historySize" value="${cms.livePortalTrace.history.size}"/>
  </bean>

  <bean id="pageRequestProcessorFactory"
        class="com.enonic.cms.core.portal.processor.PageRequestProcessorFactory"/>

  <bean id="portalAccessService" class="com.enonic.cms.core.portal.PortalAccessService"/>

  <bean id="datasourcesContextXmlCreator"
        class="com.enonic.cms.core.portal.datasource.context.DatasourcesContextXmlCreator"/>

  <bean id="datasourceInfoResolver" class="com.enonic.cms.core.tools.DataSourceInfoResolver"/>

  <bean id="siteCachesService" class="com.enonic.cms.core.portal.cache.SiteCachesServiceImpl">
    <property name="pageCacheServiceFactory">
      <bean class="com.enonic.cms.core.portal.cache.PageCacheServiceFactory">
        <property name="sitePropertiesService" ref="sitePropertiesService"/>
      </bean>
    </property>
    <property name="sitePropertiesService" ref="sitePropertiesService"/>
  </bean>

  <bean id="adminService" class="com.enonic.cms.core.service.AdminServiceImpl"/>

  <bean id="presentationEngine" class="com.enonic.vertical.engine.PresentationEngine"/>
  <bean id="adminEngine" class="com.enonic.vertical.engine.AdminEngine"/>

  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.ContentArticle3XMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.GeneralContentXMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.ContentDocumentXMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.ContentEnhancedImageXMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.ContentFileXMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.ContentNewsletterXMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.ContentPollXMLBuilder"/>
  <bean class="com.enonic.vertical.adminweb.handlers.xmlbuilders.SimpleContentXMLBuilder"/>

  <bean class="com.enonic.vertical.engine.handlers.BinaryDataHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.ContentHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.CommonHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.CategoryHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.ContentObjectHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.GroupHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.LanguageHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.LogHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.MenuHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.PageHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.PageTemplateHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.SectionHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.SecurityHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.UnitHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.UserHandler"/>
  <bean class="com.enonic.vertical.engine.handlers.SystemHandler"/>

  <bean id="keyHandler" class="com.enonic.vertical.engine.handlers.KeyHandler">
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>

  <bean id="mimeTypeResolver" class="com.enonic.cms.framework.util.MimeTypeResolverImpl">
    <property name="mimetypesLocation" value="${cms.home}/config/mimetypes.properties"/>
  </bean>

  <bean id="schedulerManager" class="com.enonic.vertical.work.quartz.QuartzSchedulerManager">
    <property name="enabled" value="${cms.scheduler.enabled}"/>
    <property name="clustered" value="true"/>
  </bean>

  <bean class="com.enonic.vertical.work.quartz.QuartzWorkService"/>

  <bean name="schedulerTranscationTemplate" class="org.springframework.transaction.support.TransactionTemplate">
    <property name="transactionManager" ref="transactionManager"/>
    <property name="propagationBehaviorName" value="PROPAGATION_REQUIRES_NEW"/>
    <property name="timeout" value="${cms.scheduler.tx.timeout}"/>
  </bean>

  <bean id="workRunner" class="com.enonic.vertical.work.WorkRunnerImpl">
    <property name="transactionTemplate" ref="schedulerTranscationTemplate"/>
  </bean>

  <bean id="nodeSettingsBuilder" class="com.enonic.cms.core.search.NodeSettingsBuilderImpl"/>

  <bean id="indexSettingsBuilder" class="com.enonic.cms.core.search.IndexSettingsBuilderImpl"/>

</beans>
