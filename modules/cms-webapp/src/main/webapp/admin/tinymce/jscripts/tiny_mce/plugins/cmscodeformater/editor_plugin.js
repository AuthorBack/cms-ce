(function(){tinymce.create('tinymce.plugins.CMSCodeFormater',{init:function(ed,url){var t=this;ed.onGetContent.add(function(ed,o){t._populateEmptyTableCells(o)});if(tinymce.isIE){ed.onKeyDown.add(function(ed,e){var n,s=ed.selection;if(e.keyCode==13&&s.getNode().nodeName=='PRE'){s.setContent('<br id="__" />&nbsp;',{format:'raw'});n=ed.dom.get('__');n.removeAttribute('id');s.select(n);s.collapse();return tinymce.dom.Event.cancel(e)}})}ed.onBeforeGetContent.add(function(ed,o){t._cleanPreTag(ed)})},getInfo:function(){return{longname:'CMS Code Fromater',author:'tan@enonic.com',authorurl:'http://www.enonic.com',infourl:'http://www.enonic.com',version:"1.0"}},_cleanPreTag:function(ed){if(tinymce.isIE){var preElems=ed.getDoc().getElementsByTagName('pre');var preElemsLn=preElems.length;for(var x=0;x<preElemsLn;x++){var preElem=preElems[x];var temp=preElem.innerHTML.split('&nbsp;');preElem.innerHTML=temp.join('')}}var br=ed.dom.select('pre br');for(var i=0;i<br.length;i++){var nlChar;if(tinymce.isIE)nlChar='\r\n';else nlChar='\n';var nl=ed.getDoc().createTextNode(nlChar);ed.dom.insertAfter(nl,br[i]);ed.dom.remove(br[i])}},_populateEmptyTableCells:function(o){o.content=o.content.replace(/<td><\/td>/g,'<td>&nbsp;</td>');o.content=o.content.replace(/<th><\/th>/g,'<th>&nbsp;</th>')}});tinymce.PluginManager.add('cmscodeformater',tinymce.plugins.CMSCodeFormater)})();